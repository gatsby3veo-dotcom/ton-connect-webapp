<body>
  <div style="font-family: Arial; padding: 16px;">
    <h3>TON Connect</h3>

    <!-- –¢—É—Ç –±—É–¥–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å, –Ω–æ –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—à—É) -->
    <div id="ton-connect" style="margin-bottom: 12px;"></div>

    <!-- ‚úÖ –ù–∞—à–∞ –∫–Ω–æ–ø–∫–∞: –ø–æ –∫–ª–∏–∫—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥ -->
    <button id="connectBtn" style="padding: 12px 16px; font-size: 16px;">
      üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫
    </button>

    <!-- –ï—Å–ª–∏ –∫–æ—à–µ–ª–µ–∫ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω —Ä–∞–Ω–µ–µ ‚Äî –ø–æ–∫–∞–∂–µ–º –∏ –¥–∞–¥–∏–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞ -->
    <div id="already" style="margin-top: 14px; display:none;">
      <div>‚úÖ –ö–æ—à–µ–ª–µ–∫ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω:</div>
      <div id="addr" style="word-break: break-all; margin: 8px 0;"></div>
      <button id="useBtn" style="padding: 12px 16px; font-size: 16px;">
        ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∫–æ—à–µ–ª–µ–∫
      </button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: window.location.origin + '/tonconnect-manifest.json',
      buttonRootId: 'ton-connect'
    });

    let userInitiated = false;

    // ‚úÖ –ö–ª–∏–∫ –ø–æ –Ω–∞—à–µ–π –∫–Ω–æ–ø–∫–µ ‚Äî —Ç–æ—á–Ω–æ –ª–æ–≤–∏—Ç—Å—è
    document.getElementById('connectBtn').addEventListener('click', async () => {
      userInitiated = true;
      await tonConnectUI.openModal(); // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–æ—à–µ–ª—å–∫–∞
    });

    // –ï—Å–ª–∏ –∫–æ—à–µ–ª–µ–∫ —É–∂–µ –±—ã–ª –ø–æ–¥–∫–ª—é—á–µ–Ω —Ä–∞–Ω–µ–µ (–∫—ç—à) ‚Äî –ø–æ–∫–∞–∂–µ–º ‚Äú–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å‚Äù
    async function showIfAlreadyConnected() {
      const wallet = tonConnectUI.wallet;
      if (wallet?.account?.address) {
        document.getElementById('already').style.display = 'block';
        document.getElementById('addr').textContent = wallet.account.address;
      }
    }

    document.getElementById('useBtn').addEventListener('click', () => {
      const wallet = tonConnectUI.wallet;
      if (wallet?.account?.address) {
        tg.sendData(JSON.stringify({ wallet: wallet.account.address }));
        tg.close();
      }
    });

    tonConnectUI.onStatusChange(wallet => {
      if (wallet?.account?.address) {
        // –ü–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–∫–æ–≥–¥–∞ —é–∑–µ—Ä –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª) ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º
        if (userInitiated) {
          tg.sendData(JSON.stringify({ wallet: wallet.account.address }));
          tg.close();
        } else {
          // –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ "—Å–∞–º–æ" –∏–∑ –∫—ç—à–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –±–ª–æ–∫ ‚Äú—É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω‚Äù
          showIfAlreadyConnected();
        }
      }
    });

    showIfAlreadyConnected();
  </script>
</body>
